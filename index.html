<!DOCTYPE html>
<html>
    <head>
        <title>Functionality without compromises</title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous"/>
        <script src="fetchEvents.js"></script>
        <script type="module" src="httpHiddenMethod.js"></script>
        <!--<script type="module" src="tasks.js"></script>-->
    </head>
    <body>
        <div class="container">
            <h1 id="title" class="text-center">Functionality without compromises</h1>
            <br/>
            <p class="lead">Helpful utilities implemented with pure javascript.</p>
            <br/>
            <form>
                <div class="form-group">
                    <h2>fetchEvents.js - Document Scope Fetch Events</h2>
                    <br/>
                    <p>Add events listeners to the document object and execute code when a fetch happens.</p>
                    <p>
                        <code>document.addEventListener("fetchStart", fnListener);</code>
                    </p>
                    <table class="table table-sm">
                        <caption>Available events</caption>
                        <thead>
                            <tr>
                                <th>Event Name</th>
                                <th>Event Detail Properties</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>fetchStart</code></td>
                                <td><code>event.detail.url, event.detail.init</code></td>
                            </tr>
                            <tr>
                                <td><code>fetchComplete</code></td>
                                <td><code>event.detail.url, event.detail.init, event.detail.response</code></td>
                            </tr>
                            <tr>
                                <td><code>fetchFail</code></td>
                                <td><code>event.detail.url, event.detail.init, event.detail.error</code></td>
                            </tr>
                        </tbody>
                    </table>
                    <p>Example:</p>
                    <button type="button" onclick="fetchUrl('GET', 'data.json', 'logFetch')" class="btn btn-primary">
                        Fetch numbers
                    </button>
                    <button type="button" onclick="fetchUrl('GET', 'example.json', 'logFetch')" class="btn btn-primary">
                        Fetch non existing data
                    </button>
                    <br/>
                    <br/>
                    <p id="logFetch" class="font-italic"></p>
                    <br/>
                    <br/>
                    <br/>
                </div>
                <div class="form-group">
                    <h2>httpHiddenMethod.js - Hidden Method Param</h2>
                    <br/>
                    <p>Use a hidden method param in your application when an HTTP PUT or DELETE method is not allowed in a host or server (maybe because of security policies not controlled by you).</p>
                    <p>The HTPP method is converted to POST and a param is used instead.</p>
                    <p>Example:</p>
                    <button type="button" onclick="fetchUrl('DELETE', 'data.json', 'logHiddenMethod')" class="btn btn-primary">
                        Fetch with PUT method.
                    </button>
                    <br/>
                    <br/>
                    <p id="logHiddenMethod" class="font-italic"></p>
                </div>
                <br/>
                <br/>
                <br/>
                <br/>
                <div class="form-group">
                    <h2>hashtracker.js - Module for Hash Location Functions</h2>
                    <br/>
                    <p>
                        Call functions when the hash location of the windows is changed.
                    </p>
                    <p>
                        <code>hashTracker.given("#/init").then(fn);</code>
                    </p>
                    <p id="exampleLabel">Example:</p>
                    <a href="#/init" class="btn btn-link">
                        Init
                    </a>
                    <br/>
                    <a href="#/hello/world" class="btn btn-link">
                        Hello
                    </a>
                    <br/>
                    <br/>
                    <br/>
                </div>
                <div class="form-group">
                    <h2>urlRewriter.js - URL fetch rewriter.</h2>
                    <br/>
                    <p>
                        Add a base prefix domain/context to relative urls invoked by fetch.
                    </p>
                    <br/>
                    <button type="button" onclick="fetchRewrite('GET', 'data.json', 'logUrlRewriter')" class="btn btn-primary">
                        Fetch
                    </button>
                    <br/>
                    <br/>
                    <p id="logUrlRewriter" class="font-italic"></p>
                    <br/>
                    <br/>
                </div>
                <div class="form-group">
                    <h2>tasks.js - Task Class</h2>
                    <br/>
                    <p>
                        A class for execution.
                    </p>
                    <br/>
                    <br/>
                    <br/>
                </div>
            </form>
        </div>
        <script type="module">
            import {hashLocationTracker} from "./hashLocationTracker.js";
            
            import {urlRewriter} from "./urlRewriter.js";
            
            document.addEventListener("fetchStart", event => {
                if(window.logId) {
                    document.getElementById(window.logId).innerHTML="Fetch start. Url: ["+event.detail.url+"]. HTTP Method: ["+event.detail.init.method+"]";
                }
            });
            document.addEventListener("fetchComplete", event => {
                if(window.logId) {
                    event.detail.response.json().then(content => {
                        document.getElementById(window.logId).innerHTML+="<br/>Fetch complete. Url: ["+event.detail.url+"]. HTTP Method: ["+event.detail.init.method+"]. Response: "+content+".";
                    });
                }
            });
            document.addEventListener("fetchFail", event => {
                if(window.logId) {
                    document.getElementById(window.logId).innerHTML+="<br/>Fetch fail. Url: ["+event.detail.url+"]. HTTP Method: ["+event.detail.init.method+"].";
                }
            });
            hashLocationTracker.given("#/init").then(()=> {
                document.getElementById("exampleLabel").innerHTML="Init";
            });
            hashLocationTracker.given("#/hello/(.+)").then(matchResult => {
                document.getElementById("exampleLabel").innerHTML="Hello, "+matchResult[1]+"!";
            });
            hashLocationTracker.given("").then(matchResult => {
                document.getElementById("exampleLabel").innerHTML="Example:";
            });
            urlRewriter.baseUrl="";
            hashLocationTracker.processCurrent();
            
            window.fetchUrl=function(method, url, logId) {
                window.logId=logId;
                window.fetch(url, {
                    method: method
                });
            }
            
            window.fetchRewrite = function(method, url, logId) {
                urlRewriter.appContext=window.location.protocol+"//"+window.location.host+(window.location.host.indexOf("localhost") === -1? "": "/dnx-runner/directJs");
                let effectiveUrl = urlRewriter.rewrite(url);
                window.fetchUrl(method, url, logId);
                urlRewriter.appContext="";
            };
            
        </script>
    </body>
</html>
